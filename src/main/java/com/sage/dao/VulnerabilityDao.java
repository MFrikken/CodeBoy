package com.sage.dao;

import com.sage.model.vulnerability.VulnerabilityModel;

import java.sql.Clob;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

public class VulnerabilityDao extends Dao<VulnerabilityModel, Integer> {

    private static VulnerabilityDao instance;

    private VulnerabilityDao() {
        super();
    }

    public static VulnerabilityDao instance() {
        if (instance == null)
            instance = new VulnerabilityDao();

        return instance;
    }

    @Override
    public boolean create(VulnerabilityModel entity) {
        try {
            tx.begin();
            em.persist(entity);
            tx.commit();
            return true;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();

            LOGGER.severe("[VulnerabilityDao] Error while inserting new vulnerability entity into database: " + e.getMessage());
            return false;
        }
    }

    @Override
    public VulnerabilityModel read(Integer key) {
        try {
            tx.begin();
            VulnerabilityModel vulnerabilityModel = em.find(VulnerabilityModel.class, key);
            tx.commit();
            return vulnerabilityModel;
        } catch (Exception e) {
            LOGGER.warning("[VulnerabilityDao] Error while trying to fetch entity with (id)=" + key);
            return null;
        }

    }

    @Override
    VulnerabilityModel update(Integer key, VulnerabilityModel newEntity) {
        tx.begin();
        VulnerabilityModel entity = em.find(VulnerabilityModel.class, key);
        if (entity == null) {
            LOGGER.warning(String.format("[VulnerabilityDao] Error while updating entity. Entity with id=(%d) could not be found.", key));
            return null;
        } else {
            // update (actually not even necessary for this project :P
        }

        throw new UnsupportedOperationException("Unimplemented method 'update'");
    }

    @Override
    boolean delete(Integer key) {
        // TODO Auto-generated method stub
        // Not necessary for this project :P
        throw new UnsupportedOperationException("Unimplemented method 'delete'");
    }

    public List<VulnerabilityModel> readAll() {
        String query = "SELECT * FROM vulnerabilities;";

        List<Object[]> results = em.createNativeQuery(query).getResultList();
        List<VulnerabilityModel> vulnerabilityModels = new ArrayList<>();

        for (Object[] row : results) {
            VulnerabilityModel vulnerabilityModel = new VulnerabilityModel(
                    ((Number) row[0]).intValue(),
                    (String) row[1],
                    (String) row[2],
                    ((Clob) row[3]).toString(),
                    (String) row[4],
                    (String) row[5],
                    (String) row[6],
                    (String) row[7]
            );
            vulnerabilityModels.add(vulnerabilityModel);
        }

        return vulnerabilityModels;
    }

    public HashMap<String, Integer> getSeverities() {
        String query = "SELECT severity, COUNT(*) AS count FROM vulnerabilities GROUP BY severity";

        List<Object[]> results = em.createNativeQuery(query).getResultList();
        HashMap<String, Integer> severities = new HashMap<>();

        for (Object[] row : results) {
            String severity = (String) row[0];
            Number count = (Number) row[1];
            severities.put(severity, count.intValue());
        }

        return severities;
    }

}
